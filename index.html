<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Unificador de Archivos CSV a Excel y CSV</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: border-color 0.3s;
      }
      .upload-area:hover {
        border-color: #3b82f6;
      }
      .file-list {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        margin-bottom: 5px;
      }
      .hidden {
        display: none;
      }
    </style>
</head>
<body class="bg-gray-100">
  <div class="container">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">
        <i class="fas fa-file-csv text-blue-600 mr-2"></i>Unificador de CSVs a Excel y CSV
      </h1>
      <img
        src="https://placehold.co/400x200"
        alt="Colorful abstract composition of file icons including CSV sheets and Excel spreadsheets in blue and green tones with data points floating around in a modern digital workspace"
        class="mx-auto rounded-lg shadow-lg mb-4"
      />
      <p class="text-gray-600">
        Sube varios archivos CSV para combinarlos en un único archivo Excel o CSV. La herramienta procesa los datos en tu navegador para mantener la privacidad.
      </p>
    </header>

    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">
        <i class="fas fa-upload text-green-600 mr-2"></i>Subir Archivos CSV
      </h2>
      <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
        <p class="text-lg text-gray-600 mb-2">
          Arrastra y suelta archivos CSV aquí o haz clic para seleccionar
        </p>
        <input type="file" id="fileInput" multiple accept=".csv" class="hidden" />
        <button
          onclick="document.getElementById('fileInput').click()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
          <i class="fas fa-folder-open mr-2"></i>Seleccionar Archivos
        </button>
      </div>
      <div id="fileList" class="file-list hidden">
        <h3 class="text-lg font-medium text-gray-700 mb-2">Archivos Seleccionados:</h3>
        <div id="fileItems"></div>
      </div>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">
        <i class="fas fa-cogs text-purple-600 mr-2"></i>Configuración
      </h2>
      <label class="flex items-center mb-4">
        <input type="checkbox" id="hasHeaders" checked class="mr-2" />
        <span class="text-gray-600">Los archivos tienen encabezados en la primera fila</span>
      </label>
      <button
        id="processBtn"
        onclick="processFiles()"
        class="bg-green-600 text-white px-6 py-3 rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-700 transition"
      >
        <i class="fas fa-play mr-2"></i>Procesar y Unificar
      </button>
    </section>

    <section id="resultSection" class="bg-white p-6 rounded-lg shadow-md hidden">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">
        <i class="fas fa-download text-orange-600 mr-2"></i>Resultado
      </h2>
      <p id="resultMessage" class="text-gray-600 mb-4"></p>
      <div class="flex gap-4">
        <button
          id="downloadExcelBtn"
          onclick="downloadExcel()"
          class="bg-orange-600 text-white px-6 py-3 rounded hover:bg-orange-700 transition flex items-center"
        >
          <i class="fas fa-file-excel mr-2"></i>Descargar Excel Unificado
        </button>
        <button
          id="downloadCsvBtn"
          onclick="downloadCsv()"
          class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 transition flex items-center"
        >
          <i class="fas fa-file-csv mr-2"></i>Descargar CSV Unificado
        </button>
      </div>
    </section>
  </div>

  <script>
    let files = [];
    let data = [];
    let workbook = null;

    document.getElementById("fileInput").addEventListener("change", handleFiles);
    document
      .getElementById("uploadArea")
      .addEventListener("dragover", (e) => e.preventDefault());
    document
      .getElementById("uploadArea")
      .addEventListener("drop", handleDrop);

    function handleFiles(event) {
      const selectedFiles = Array.from(
        event.target.files || event.dataTransfer.files
      ).filter(
        (file) => file.type === "text/csv" || file.name.endsWith(".csv")
      );
      if (selectedFiles.length > 0) {
        files = selectedFiles;
        displayFileList();
      }
    }

    function handleDrop(event) {
      event.preventDefault();
      handleFiles({ target: { files: event.dataTransfer.files } });
    }

    function displayFileList() {
      const fileList = document.getElementById("fileList");
      const fileItems = document.getElementById("fileItems");
      fileItems.innerHTML = "";
      files.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";
        item.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-file-csv text-green-500 mr-2"></i>
                        <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
        fileItems.appendChild(item);
      });
      fileList.classList.remove("hidden");
    }

    function removeFile(index) {
      files.splice(index, 1);
      displayFileList();
      if (files.length === 0) {
        document.getElementById("fileList").classList.add("hidden");
      }
    }

    function processFiles() {
      if (files.length === 0) {
        alert("Por favor, selecciona al menos un archivo CSV.");
        return;
      }

      document.getElementById("processBtn").disabled = true;
      document.getElementById("processBtn").innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';
      data = [];
      let processedCount = 0;

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const csvData = e.target.result;
          const parsed = Papa.parse(csvData, {
            header: document.getElementById("hasHeaders").checked,
            skipEmptyLines: true,
            delimiter: "|",
          });

          if (document.getElementById("hasHeaders").checked) {
            if (index === 0) {
              // Para el primer archivo, incluimos headers
              data = data.concat(parsed.data);
            } else {
              // Para archivos adicionales, excluimos headers
              const rows = parsed.data.filter((row) => {
                // Filtro simple: si la fila no tiene datos (solo headers potencialmente), omitirla
                return Object.values(row).some((val) => val !== "");
              });
              data = data.concat(rows);
            }
          } else {
            // Sin headers, concatenamos todas las filas
            data = data.concat(parsed.data);
          }

          processedCount++;
          if (processedCount === files.length) {
            generateExcel();
            document.getElementById("resultSection").classList.remove("hidden");
            document.getElementById(
              "resultMessage"
            ).innerHTML = `Se han procesado ${data.length} filas de ${files.length} archivos CSV. Haz clic abajo para descargar el archivo Excel o CSV.`;
            resetProcessBtn();
          }
        };
        reader.readAsText(file);
      });
    }

    function generateExcel() {
      if (data.length === 0) {
        alert("No se encontraron datos válidos para procesar.");
        resetProcessBtn();
        return;
      }

      workbook = XLSX.utils.book_new();
      const worksheet = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(workbook, worksheet, "Datos Unificados");
    }

    function downloadExcel() {
      if (workbook) {
        XLSX.writeFile(workbook, "archivos_unificados.xlsx");
      }
    }

    function downloadCsv() {
      if (data.length === 0) {
        alert("No hay datos para descargar.");
        return;
      }
      // Convertir data a CSV con PapaParse
      const csv = Papa.unparse(data, {
        delimiter: "|",
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "archivos_unificados.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function resetProcessBtn() {
      document.getElementById("processBtn").disabled = false;
      document.getElementById("processBtn").innerHTML =
        '<i class="fas fa-play mr-2"></i>Procesar y Unificar';
    }

    // Fallback para imágenes
    document.querySelectorAll("img").forEach((img) => {
      img.onerror = function () {
        this.style.display = "none";
        const fallback = document.createElement("div");
        fallback.className =
          "fallback-text bg-gray-200 p-4 rounded text-center text-gray-600";
        fallback.innerHTML =
          '<i class="fas fa-image text-4xl mb-2"></i><p>Imagen no disponible</p>';
        this.parentNode.replaceChild(fallback, this);
      };
    });
  </script>
</body>
</html>
